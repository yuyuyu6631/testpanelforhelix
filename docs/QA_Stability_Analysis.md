# 问答系统接口稳定性分析报告

## 1. 背景说明
目前系统已成功解决登录认证问题，但在自动化测试过程中，**问答接口（QA / Ask AI）** 表现出较高的不稳定性，具体表现为偶发性请求失败、SQL提取失败或超时。

## 2. 核心稳定性问题分析

### 2.1 并发冲突与 chatId 生成逻辑
- **现状分析**：在 `testcase.py` 中，`chatId` 有时使用固定常量或简单的生成逻辑。如果多个测试线程（或多次快速重复测试）使用相同的 `chatId`，服务端可能会将其视为同一会话的不同版本，导致 SSE 流式推送错乱或被服务器直接切断。
- **风险点**：并发测试时容易出现竞态条件。

### 2.2 SSE（Server-Sent Events）流式响应脆弱性
- **现状分析**：问答接口使用 SSE 协议。目前的 `_parse_sse_stream` 逻辑高度依赖于 `iter_lines()`。
- **问题**：
    - **网络抖动**：长连接容易受网络波动影响，一旦链路中断，`iter_lines()` 会抛出异常或中途退出。
    - **Buffer 截断**：如果数据块较大导致解析成不完整的 JSON 字符串，目前的解析代码会通过 `JSONDecodeError` 忽略该行，导致核心数据丢失。

### 2.3 SQL 提取算法的健壮性
- **现状分析**：系统通过递归搜索 JSON 对象（`_find_sql_recursively`）或正则表达式匹配提取 SQL。
- **问题**：
    - 模型生成的响应结构可能发生细微变化（例如 `sql` 字段被移动到不同的嵌套层级）。
    - 目前的正则表达式 `【最终SQL校验】：(SELECT ... )` 依赖于明确的提示词。如果模型回复的提示词发生漂移（例如变成了“本次生成的SQL为：”），正则就会失效。

### 2.4 超时与重试机制不足
- **现状分析**：虽然配置了 `ASK_TIMEOUT`，但针对 SSE 这种流式响应，一次简单的 Timeout 设置无法涵盖“连接建立成功但数据拉取极慢”或“中途断连”的情况。
- **问题**：缺乏指数退避（Exponential Backoff）的重试机制，一次失败即导致整条 Case 失败。

## 3. 改进建议措施

### 3.1 优化 ChatId 策略
- **措施**：在每次请求时，必须使用 `uuid` 或 `int(time.time() * 1000)` 生成绝对唯一的 `chatId`。
- **目标**：确保每个请求在服务端都是独立且新鲜的上下文。

### 3.2 增强 SSE 解析防御
- **措施**：
    - 增加对 `Chunked` 响应的容错处理。
    - 完善 `json.loads` 时的 Buffer 拼接逻辑，防止跨行截断。
    - 记录原始流数据（Raw Stream）到日志中，便于事后复盘不完整响应。

### 3.3 提升 SQL 提取多样性
- **措施**：
    - 组合多种提取方案：**路径搜索 + 关键字匹配 + 正则清洗**。
    - 增加更宽泛的匹配逻辑：只要字符串内包含 `SELECT ... FROM` 且满足基本 SQL 语法，即视为备选 SQL。

### 3.4 引入智能重试机制
- **措施**：
    - 针对 HTTP 5xx、429（限流）或网络抖动导致的异常，自动进行最多 3 次重试。
    - 给并发线程池增加“慢消费”保护，避免瞬间高并发由于 QPS 限制被服务端屏蔽。

## 4. 结论
问答接口的不稳定并非单一因素造成，而是网络协议特性、服务端会话管理和客户端解析鲁棒性的综合体现。后续将针对上述 3.1 和 3.4 优先进行代码级补强。
