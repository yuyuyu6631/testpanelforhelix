# 测试后台保活功能

## 测试场景

### 场景一：正常启动测试
1. 打开前端页面 http://localhost:5173
2. 点击"全量测试"按钮启动测试
3. 观察控制台输出，验证 WebSocket 连接成功
4. 观察测试用例逐个执行

**预期结果：**
- 测试正常启动
- WebSocket 连接成功
- 用例状态正确更新

### 场景二：页面刷新恢复测试
1. 启动测试（如场景一）
2. 等待部分测试完成（比如完成了 3 个用例）
3. **刷新浏览器页面** (F5 或 Ctrl+R)
4. 观察页面加载后的状态

**预期结果：**
- 页面显示提示："已恢复运行中的测试任务"
- 之前完成的测试结果依然显示
- 正在运行的测试继续执行
- WebSocket 自动连接到正在运行的批次

**验证步骤：**
```
1. 打开浏览器开发者工具 Console
2. 查看日志输出：
   - "恢复运行中的批次: {...}"
   - "批次状态: {...}"
3. 检查 Network 标签，确认 WebSocket 连接建立
```

### 场景三：WebSocket 断线重连
1. 启动测试
2. 打开浏览器开发者工具 -> Network -> WS
3. 找到 WebSocket 连接，右键断开 (或者暂停后端服务器)
4. 观察页面行为

**预期结果：**
- 控制台输出："WebSocket 关闭，尝试重连..."
- 3 秒后自动重连
- 控制台输出："正在重连 WebSocket..."
- 重连成功后继续接收测试结果

### 场景四：后端崩溃恢复
1. 启动测试
2. 在测试运行中途，**关闭后端服务器**
3. 等待几秒钟
4. **重启后端服务器**
5. 观察前端页面

**预期结果：**
- 页面显示"服务已离线"警告
- WebSocket 自动尝试重连
- 后端重启后，WebSocket 重新连接
- 测试从中断处继续（如果后台任务还在运行）

### 场景五：切换浏览器标签页
1. 启动测试
2. 切换到其他浏览器标签页
3. 等待一段时间
4. 切换回测试页面

**预期结果：**
- 测试继续运行
- 所有已完成的测试结果正确显示
- 不会丢失任何测试数据

## 后端验证

### 验证 API 端点

#### 1. 查询活跃批次
```bash
curl http://localhost:8000/run/active-batches
```

**预期响应：**
```json
[
  {
    "batch_id": "8e04e3b4-4d74-4623-978d-174db96a7ba3",
    "start_time": "2026-02-03T14:43:48",
    "total_count": 10,
    "completed_count": 3,
    "pass_count": 2
  }
]
```

#### 2. 查询批次历史
```bash
curl http://localhost:8000/run/history/{batch_id}
```

### 验证数据库持久化

连接到数据库查看批次状态：
```bash
cd apiautotest/data
sqlite3 autotest.db

# 查看运行中的批次
SELECT * FROM test_batches WHERE status = 'RUNNING';

# 查看批次的测试历史
SELECT COUNT(*) FROM test_history WHERE batch_id = '{your_batch_id}';
```

## 调试建议

### 前端调试
在浏览器控制台运行：
```javascript
// 查看当前状态
console.log('Running:', running);
console.log('Batch ID:', batchId);
console.log('WebSocket:', wsRef.current);

// 手动触发恢复
client.get('/run/active-batches').then(res => console.log(res.data));
```

### 后端调试
查看后端日志：
```bash
# Windows
cd apiautotest/backend
type logs\backend.log | findstr /i "batch"

# 或者实时查看
Get-Content logs\backend.log -Wait -Tail 20
```

## 已知问题和限制

1. **多批次并发**：当前实现只恢复最新的批次，如果有多个批次同时运行，只会恢复第一个
2. **批次清理**：完成的批次不会自动从 `RUNNING` 状态更新，需要依赖后端任务完成时更新
3. **WebSocket 重连延迟**：固定 3 秒重连，可能需要根据实际情况调整
4. **用例列表恢复**：重连时只恢复结果，用例列表需要从 `init` 消息或历史记录重建

## 下一步优化

- [ ] 支持多批次管理界面
- [ ] 添加批次进度条和预计完成时间
- [ ] 实现批次暂停/恢复功能
- [ ] 添加批次自动清理机制（完成后 X 小时）
- [ ] 优化 WebSocket 重连策略（指数退避）
