# 前端对接接口文档 V4.1

本文档专门为前端开发整理，按页面功能模块划分接口调用。

**Base URL**: `http://localhost:8000` (或配置的后端地址)

---

## 1. 系统配置 (Config)
*用于全局配置页面或应用初始化加载*

| 功能 | 方法 | 路径 | 参数/Body | 返回值关键字段 |
| :--- | :--- | :--- | :--- | :--- |
| **获取配置** | `GET` | `/config` | 无 | `user_token`, `max_workers` |
| **保存配置** | `POST` | `/config` | `{"user_token": "...", "max_workers": 5}` | 更新后的配置对象 |

---

## 2. 用例管理页 (Test Cases)
*位置: `/cases` 页面*

### 列表与查询
| 功能 | 方法 | 路径 | 参数 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **加载用例列表** | `GET` | `/cases` | `?skip=0&limit=100` | 返回用例数组 |

### 用例操作
| 功能 | 方法 | 路径 | Body |
| :--- | :--- | :--- | :--- |
| **新建用例** | `POST` | `/cases` | `{"question": "...", "is_active": true}` |
| **编辑用例** | `PUT` | `/cases/{id}` | 完整的用例对象 |
| **删除单条** | `DELETE` | `/cases/{id}` | 无 |
| **批量删除** | `DELETE` | `/cases/batch` | Body: `[id1, id2, id3]` (注意 Content-Type: application/json) |
| **清空所有** | `DELETE` | `/cases/clear-all` | 无 |

### 批量操作
| 功能 | 方法 | 路径 | Body |
| :--- | :--- | :--- | :--- |
| **批量启用/禁用** | `POST` | `/cases/batch-status` | `{"case_ids": [...], "is_active": true/false}` |

### 导入与生成 (Action Bar)
| 功能 | 方法 | 路径 | 参数 |
| :--- | :--- | :--- | :--- |
| **上传文件导入** | `POST` | `/cases/import` | FormData: `file` (Excel/CSV) |
| **AI 自动生成** | `POST` | `/generate/cases` | Query: `?count=2` (每指标生成数) |
| **获取生成预览数据** | `GET` | `/generate/preview` | 无 (返回指标数、公司数) |

---

## 3. 测试执行页 (Test Runner)
*位置: `/runner` 页面*

### 执行控制
| 功能 | 方法 | 路径 | Body | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **开始测试** | `POST` | `/run` | `{"case_ids": []}` | 空数组表示运行所有活跃用例。返回 `batch_id` |
| **停止测试** | `POST` | `/run/stop` | Query: `?batch_id=...` | 强制停止运行中的批次 |

### 状态监控
| 功能 | 方法 | 路径 | 说明 |
| :--- | :--- | :--- | :--- |
| **获取正在运行的批次** | `GET` | `/run/active-batches` | 用于页面刷新后恢复进度条显示 |
| **WebSocket 实时日志** | `WS` | `/run/ws/{batch_id}` | 监听 `update`, `batch_status`, `done` 消息 |

**WebSocket 消息示例**:
- **进度更新 (`update`)**:
  ```json
  {
    "type": "update",
    "case_id": 1,
    "result": { "result": "PASS", "actual_sql": "SELECT...", "message": "..." }
  }
  ```
- **完成信号 (`done`)**: `{"type": "done"}`

---

## 4. 报告记录页 (Reports)
*位置: `/reports` 页面*

| 功能 | 方法 | 路径 | 备注 |
| :--- | :--- | :--- | :--- |
| **报告列表** | `GET` | `/reports` | 分页，按时间倒序 |
| **报告详情** | `GET` | `/reports/{batch_id}/details` | 获取该批次所有用例的执行详情 |
| **导出 Excel** | `GET` | `/reports/{batch_id}/export` | 直接浏览器下载或 `window.open` |

---

## 5. 通用类型定义 (TypeScript Interfaces)

```typescript
// 用例对象
interface TestCase {
  id: number;
  question: string;
  expected_keywords: string;
  expected_conditions: string;
  expected_sql?: string;
  is_active: boolean;
  updated_at: string;
}

// 测试结果
interface TestResult {
  case_id: number;
  question: string;
  actual_sql: string;
  result: "PASS" | "FAIL";
  message: string;
  duration?: number;
}

// 报告/批次概览
interface TestBatch {
  id: string;
  status: "RUNNING" | "COMPLETED" | "STOPPED";
  total_count: number;
  pass_count: number;
  start_time: string;
}
```
