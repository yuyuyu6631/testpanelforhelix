
✅ **已收到**。以下是 **接口定义管理中心（API Definition Center）** 的**完整详细版本**，可直接用于开发、评审或文档。

### 📋 接口定义管理中心（API Definition Center）详细规格

#### 1. 模块概述
- **模块定位**：V5.0 核心解耦层，是平台“配置即动力”的最重要入口。
- **目标**：让用户通过可视化界面完整定义一个可复用的接口模板，支持多环境、多版本、多业务线，彻底摆脱代码硬编码。
- **核心价值**：接口变更时，只需修改/新建模板或版本，即可让所有绑定该模板的用例自动适配。

#### 2. 数据模型（InterfaceTemplate / ApiDefinition）

**主表：interface_templates**

| 字段                  | 类型          | 是否必填 | 说明与示例 |
|-----------------------|---------------|----------|------------|
| id                    | Integer (PK)  | 是       | 自增主键 |
| project_id            | Integer (FK)  | 是       | 所属项目 |
| code                  | String (unique) | 是     | 模板唯一标识（如 `order_create_v2`） |
| name                  | String        | 是       | 接口名称（如 `创建订单`） |
| description           | Text          | 否       | 接口功能描述 |
| version               | String        | 是       | 版本号（如 `v1.0`, `v2.0`, `202502`） |
| base_url              | String        | 是       | 基础地址（如 `https://api.example.com`） |
| method                | Enum          | 是       | GET/POST/PUT/PATCH/DELETE |
| endpoint              | String        | 是       | 路径，支持变量（如 `/api/v{version}/orders/{order_id}`） |
| body_type             | Enum          | 是       | json / form-data / raw / none |
| body_template         | Text (JSON)   | 否       | Jinja2 模板字符串（如 `{"prompt": "{{prompt}}", "chat_id": "{{chat_id}}"}`） |
| query_params          | JSON          | 否       | 查询参数模板（如 `{"page": "{{page}}", "size": 20}`） |
| headers               | JSON          | 否       | 请求头模板（支持变量） |
| auth_type             | Enum          | 是       | none / bearer / apikey / basic / custom / oauth2 |
| auth_config           | JSON          | 否       | 鉴权具体配置（动态结构，见下文） |
| response_parser       | JSON          | 是       | 解析规则（见下文） |
| timeout               | Integer       | 是       | 默认超时（秒），默认 10 |
| retry_count           | Integer       | 否       | 重试次数，默认 0 |
| is_active             | Boolean       | 是       | 是否启用 |
| created_by            | String        | 是       | 创建人 |
| created_at            | DateTime      | 是       | 创建时间 |

**auth_config 动态结构示例**：
- bearer: `{"token": "{{global_token}}"}`
- apikey: `{"key_name": "X-API-Key", "value": "sk-xxx"}`
- custom: `{"hook_function": "generate_sign", "params": {...}}`

**response_parser 示例**：
```json
{
  "actual_sql": "$.data.sql_query",
  "status_code": "$.code",
  "error_msg": "$.message",
  "extra": "$.data.metadata"
}
```

#### 3. 核心功能点详细

1. **接口模板 CRUD**
   - 列表页：支持搜索（name/code/version）、过滤（project、auth_type、method）
   - 新建/编辑：分步表单向导（基础信息 → 请求配置 → 鉴权 → 响应解析 → 高级设置）
   - 删除：软删除 + 确认绑定用例数量

2. **版本管理**
   - 支持从现有模板“一键克隆为新版本”
   - 版本列表：显示 v1.0 → v2.0 → v3.0 历史
   - 用例可指定绑定“最新版本”或固定版本
   - 版本对比视图（Diff）

3. **多维度模板组织**
   - 支持按项目、环境（dev/qa/prod）、业务线（sql-gen / chat / image 等）筛选
   - 可设置默认模板（某个 project 的默认接口）

4. **请求配置**
   - Endpoint 支持路径变量 `{var}` 和 Jinja2 `{{var}}`
   - Body 支持 4 种类型，json 类型默认使用 Jinja2
   - Query Params 与 Headers 均支持变量模板

5. **鉴权配置（动态表单）**
   - 选择 auth_type 后，右侧动态显示对应表单字段
   - 支持引用全局配置（如 `{{global_bearer_token}}`）
   - Custom 类型允许填写钩子名称 + 参数

6. **响应解析规则**
   - 支持多条提取规则（key → JSONPath / XPath / Regex）
   - 可标记关键字段（如 actual_sql）
   - 支持默认值、转换规则（可选）

7. **高级设置**
   - 超时、重试策略、预期状态码
   - 忽略 SSL、代理设置（未来扩展）

8. **预览与调试功能（最重要）**
   - 在模板编辑页右下角提供“预览面板”
   - 输入测试数据（logic_data JSON）
   - 点击“发送请求”按钮
   - 实时显示：
     - 最终渲染后的 URL
     - 最终 Headers
     - 最终 Body（美化格式）
     - 原始响应（JSON 树 + Raw）
     - 提取结果（根据 response_parser）
     - 断言结果预览（可选）

#### 4. 用户操作流程（典型场景）
1. 进入 API Definition Center → 新建模板
2. 填写基础信息 + 选择 method + 输入 endpoint
3. 配置 Body 类型与模板
4. 配置鉴权类型 → 填写对应参数
5. 配置响应解析规则（重点填写 actual_sql 的 JSONPath）
6. 保存 → 进入预览模式 → 输入测试 Prompt → 发送验证
7. 确认正确 → 发布版本 → 用例管理页绑定该模板

#### 5. 推荐前端实现要点（Streamlit / React 通用）
- 使用 Tabs 分步引导：Basic → Request → Auth → Response → Preview
- JSON 编辑器推荐：Monaco Editor 或 react-json-view
- 动态表单：根据 auth_type 渲染不同字段组
- 预览区：左右分栏（输入区 + 结果区）

