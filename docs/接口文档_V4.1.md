# 智能接口自动化测试平台 V4.1 接口文档

## 1. 简介
本文档描述了 Helix AutoTest V4.1 平台的后端 API 接口。
相比 V4.0，本次更新补充了删除操作、历史记录查询及测试报告导出等接口。

- **Base URL**: `http://localhost:8000`
- **版本**: V4.1

## 2. 接口列表

### 2.1 系统配置 (Config)

#### 获取当前配置
- **URL**: `/config`
- **Method**: `GET`
- **Response**:
```json
{
  "user_token": "eyJhb...",
  "max_workers": 5,
  "headers": {}
}
```

#### 更新配置
- **URL**: `/config`
- **Method**: `POST`
- **Body**:
```json
{
  "user_token": "new_token",
  "max_workers": 10
}
```

### 2.2 用例管理 (Cases)

#### 获取用例列表
- **URL**: `/cases`
- **Method**: `GET`
- **Query Params**:
  - `skip`: 偏移量 (默认 0)
  - `limit`: 数量 (默认 100)

#### 创建用例
- **URL**: `/cases`
- **Method**: `POST`
- **Body**:
```json
{
  "question": "查询用户列表",
  "expected_keywords": "select, users",
  "is_active": true
}
```

#### 更新用例 (全量)
- **URL**: `/cases/{case_id}`
- **Method**: `PUT`

#### 更新用例 (部分)
- **URL**: `/cases/{case_id}`
- **Method**: `PATCH`

#### 删除单个用例 [NEW]
- **URL**: `/cases/{case_id}`
- **Method**: `DELETE`
- **Response**: `{"ok": True}`

#### 批量删除用例 [NEW]
- **URL**: `/cases/batch`
- **Method**: `DELETE`
- **Body**: (注意：这里实际是 DELETE 请求带 body，某些客户端可能不支持，需确认 axios/fetch 配置)
```json
[1, 2, 3] 
// 注意：后端实现为 query param `case_ids` 列表，还是 body？
// 检查代码：case_ids: List[int], db...，FastAPI 默认 list 为 body
```
- **Response**: `{"deleted": 3}`

#### 清空所有用例 [NEW]
- **URL**: `/cases/clear-all`
- **Method**: `DELETE`
- **Response**: `{"deleted": 100}`

#### 批量状态更新
- **URL**: `/cases/batch-status`
- **Method**: `POST`
- **Body**:
```json
{
  "case_ids": [1, 2, 3],
  "is_active": false
}
```

#### 导入 Excel/CSV
- **URL**: `/cases/import`
- **Method**: `POST`
- **Form Data**: `file` (Binary)

### 2.3 测试执行 (Runner)

#### 触发测试 (异步)
- **URL**: `/run`
- **Method**: `POST`
- **Body**:
```json
{
  "case_ids": []  // 空列表代表运行所有活跃用例
}
```
- **Response**:
```json
{
  "message": "Test run started",
  "batch_id": "uuid-string",
  "cases": [...]
}
```

#### 停止测试
- **URL**: `/run/stop`
- **Method**: `POST`
- **Query Param**: `batch_id`

#### 获取活跃批次 [NEW]
- **URL**: `/run/active-batches`
- **Method**: `GET`
- **Response**:
```json
[
  {
    "batch_id": "uuid",
    "start_time": "...",
    "total_count": 100,
    "completed_count": 50,
    "pass_count": 48
  }
]
```

#### 获取运行历史 (原始结果) [NEW]
- **URL**: `/run/history/{batch_id}`
- **Method**: `GET`
- **Response**: `List[TestResult]`

#### 实时日志 (WebSocket)
- **URL**: `ws://localhost:8000/run/ws/{batch_id}`
- **Message Types**:
  - `init`: 初始用例列表
  - `running`: 某条用例开始执行
  - `update`: 某条用例执行完成 (含结果)
  - `batch_status`: 批次状态同步
  - `done`: 全部完成

### 2.4 报告管理 (Reports)

#### 获取报告列表
- **URL**: `/reports`
- **Method**: `GET`
- **Query Params**: `skip`, `limit`
- **Response**:
```json
[
  {
    "id": "uuid",
    "start_time": "2026-02-04T10:00:00",
    "status": "COMPLETED",
    "total_count": 100,
    "pass_count": 95
  }
]
```

#### 获取报告概览
- **URL**: `/reports/{batch_id}`
- **Method**: `GET`

#### 获取报告详情
- **URL**: `/reports/{batch_id}/details`
- **Method**: `GET`
- **Response**:
```json
[
  {
    "case_id": 1,
    "question": "...",
    "actual_sql": "...",
    "result": "PASS",
    "message": ""
  }
]
```

#### 导出报告 [NEW]
- **URL**: `/reports/{batch_id}/export`
- **Method**: `GET`
- **Response**: Binary File (.xlsx)

### 2.5 自动生成 (Generator)

#### 生成用例
- **URL**: `/generate/cases`
- **Method**: `POST`
- **Query Param**: `count` (每指标生成数量)

#### 预览元数据
- **URL**: `/generate/preview`
- **Method**: `GET`
