# Helix AutoTest V4.0

# 前端重构最终实现方案（React + Ant Design）

---

## 一、项目目标

构建一套 **稳定、可扩展、支持实时测试执行监控** 的中后台前端系统，实现以下业务闭环：

> 用例管理 → 批量执行 → 实时日志 → 报告分析 → AI 自动生成

系统需满足：

* 支持大量测试用例（分页、虚拟滚动）
* 支持实时 WebSocket 日志流
* 支持复杂报告对比视图（SQL Diff）
* 长期可维护、可扩展

---

## 二、技术架构总览

| 分类     | 技术方案                      | 作用                |
| ------ | ------------------------- | ----------------- |
| 框架     | React 18 + TypeScript     | 核心框架              |
| 构建工具   | Vite 5                    | 快速启动 & 构建         |
| UI库    | Ant Design 5              | 中后台组件体系           |
| 状态管理   | Zustand                   | 客户端状态（UI / WS 状态） |
| 服务端状态  | TanStack Query            | 请求缓存、自动刷新         |
| 网络请求   | Axios                     | API 请求封装          |
| 实时通信   | 原生 WebSocket              | 测试执行实时日志          |
| 图表     | ECharts / Recharts        | 报告统计              |
| 代码编辑器  | Monaco Editor             | JSON / SQL 展示     |
| Diff对比 | react-diff-viewer         | SQL 差异高亮          |
| 样式     | Tailwind CSS + AntD Token | 布局 & 主题控制         |

---

## 三、前端系统分层架构

```
┌──────────────── UI 页面层 (Pages)
│
├── 业务组件层 (Features Components)
│
├── 状态层
│   ├── React Query (服务端数据)
│   └── Zustand (客户端运行时状态)
│
├── API 访问层 (Services)
│
└── 基础设施层
    ├── Axios 实例
    ├── WebSocket 管理器
    └── 工具函数
```

---

## 四、目录结构（最终标准版）

```
src/
├── api/
│   ├── client.ts                # Axios 实例 & 拦截器
│   ├── types.ts                 # 全局 DTO 类型
│   └── services/
│       ├── config.ts
│       ├── cases.ts
│       ├── runner.ts
│       ├── reports.ts
│       └── generator.ts
│
├── stores/
│   ├── useAppStore.ts           # 全局UI状态
│   └── useRunnerStore.ts        # 执行过程状态
│
├── pages/
│   ├── Dashboard/
│   ├── Cases/
│   ├── Runner/
│   ├── Reports/
│   ├── Generator/
│   └── Settings/
│
├── components/
│   ├── layout/
│   ├── common/
│   ├── runner/
│   └── report/
│
├── websocket/
│   └── runnerSocket.ts          # WS封装
│
├── hooks/                       # React Query Hooks
├── utils/
├── styles/
└── App.tsx
```

---

## 五、接口访问层设计

### Axios 实例

```ts
// api/client.ts
export const client = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
});

client.interceptors.response.use(
  res => res,
  err => {
    const error = {
      message: err.response?.data?.detail || "Server Error",
      code: err.response?.status,
    };
    return Promise.reject(error);
  }
);
```

---

### 示例：用例 API

```ts
export const getCases = (params) =>
  client.get('/cases', { params }).then(res => res.data);

export const createCase = (data) =>
  client.post('/cases', data);
```

---

## 六、服务端状态管理（React Query）

### Query 规范

| 类型   | 命名规范                |
| ---- | ------------------- |
| 列表   | ['cases', params]   |
| 详情   | ['case', id]        |
| 报告列表 | ['reports']         |
| 报告详情 | ['report', batchId] |

### Mutation 示例

```ts
export const useCreateCase = () => {
  const qc = useQueryClient();
  return useMutation(createCase, {
    onSuccess: () => qc.invalidateQueries(['cases'])
  });
};
```

---

## 七、执行控制台（核心模块设计）

### 1️⃣ Runner 状态模型（Zustand）

```ts
type CaseRuntimeState = {
  caseId: number;
  status: 'WAITING' | 'RUNNING' | 'PASS' | 'FAIL';
  message?: string;
};

type RunnerStore = {
  batchId: string | null;
  cases: Record<number, CaseRuntimeState>;
  progress: number;
  logs: string[];
  setBatch: (id: string) => void;
  updateCase: (data: CaseRuntimeState) => void;
  pushLog: (log: string) => void;
};
```

---

### 2️⃣ WebSocket 封装

```ts
class RunnerSocket {
  ws?: WebSocket;

  connect(batchId: string) {
    this.ws = new WebSocket(`ws://localhost:8000/run/ws/${batchId}`);

    this.ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      handleRunnerMessage(msg);
    };
  }

  close() {
    this.ws?.close();
  }
}
```

---

### 3️⃣ WS 消息分发逻辑

| 类型           | 前端处理           |
| ------------ | -------------- |
| init         | 初始化所有用例状态      |
| running      | 标记某用例为 RUNNING |
| update       | 写入 PASS / FAIL |
| batch_status | 更新进度条          |
| done         | 标记执行完成         |

---

## 八、页面模块实现

### 🧪 用例管理页

* AntD Table（服务端分页）
* 行内 Switch 修改启用状态
* Drawer 表单编辑
* 上传组件导入 Excel

---

### ▶ 执行控制台

布局：

```
顶部：批次进度条 + 成功率
中部：用例执行状态表格
右侧抽屉：实时日志窗口
```

颜色规范：

* 运行中：蓝色
* PASS：绿色
* FAIL：红色

---

### 📊 报告模块

#### 报告列表

* 表格展示批次历史

#### 报告概览

* 成功率图表
* 执行统计

#### 报告详情（重点）

左右分栏：

| 左侧    | 右侧        |
| ----- | --------- |
| 预期关键词 | 实际 SQL    |
| 逻辑说明  | Diff 高亮对比 |

---

## 九、系统配置页

* Token 输入框
* 并发数 Slider
* Headers JSON 编辑器（Monaco）
* 保存调用 POST /config

---

## 十、性能与体验优化策略

| 场景     | 优化方案           |
| ------ | -------------- |
| 大量用例   | 虚拟滚动表格         |
| 报告详情卡顿 | Diff 懒加载       |
| 日志量过大  | 仅保留最近 N 条      |
| 重复请求   | React Query 缓存 |
| WS 重连  | 心跳 + 自动重连机制    |

---

## 十一、安全与健壮性

* Token 本地加密存储
* 401 自动跳转配置页
* WS 断线自动重连
* 所有 Mutation 有 loading 防抖

---

## 十二、最终系统能力总结

| 能力            | 是否支持 |
| ------------- | ---- |
| 批量用例管理        | ✅    |
| AI 自动生成用例     | ✅    |
| 实时测试执行监控      | ✅    |
| WebSocket 日志流 | ✅    |
| SQL 差异可视化     | ✅    |
| 报告统计分析        | ✅    |
| 企业级可维护架构      | ✅    |

